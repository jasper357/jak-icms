name: jak-icms-dev

services:
  workspace:
    build:
      context: .
      dockerfile: .devcontainer/Dockerfile
    container_name: jak-icms-workspace
    working_dir: /home/devuser/workspace
    stdin_open: true
    tty: true
    command: /bin/bash
    volumes:
      - .:/home/devuser/workspace:cached
      - /var/run/docker.sock:/var/run/docker.sock
    depends_on:
      redpanda:
        condition: service_healthy
      debezium-connect:
        condition: service_started
      vector:
        condition: service_started

  redpanda:
    image: redpandadata/redpanda:v24.3.5
    container_name: jak-icms-redpanda
    command:
      - redpanda
      - start
      - --overprovisioned
      - --smp
      - "1"
      - --memory
      - "1G"
      - --reserve-memory
      - "0M"
      - --node-id
      - "0"
      - --check=false
      - --kafka-addr
      - PLAINTEXT://0.0.0.0:9092,OUTSIDE://0.0.0.0:${REDPANDA_KAFKA_PORT:-19092}
      - --advertise-kafka-addr
      - PLAINTEXT://redpanda:9092,OUTSIDE://localhost:${REDPANDA_KAFKA_PORT:-19092}
      - --rpc-addr
      - redpanda:33145
      - --advertise-rpc-addr
      - redpanda:33145
      - --pandaproxy-addr
      - PLAINTEXT://0.0.0.0:8082
      - --advertise-pandaproxy-addr
      - PLAINTEXT://redpanda:8082
      - --schema-registry-addr
      - 0.0.0.0:8081
    ports:
      - "${REDPANDA_KAFKA_PORT:-19092}:19092"
      - "9644:9644"
      - "8081:8081"
      - "8082:8082"
    volumes:
      - redpanda_data:/var/lib/redpanda/data
    healthcheck:
      test: ["CMD-SHELL", "rpk cluster health --exit-when-healthy || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10

  vector:
    image: timberio/vector:0.41.1-debian
    container_name: jak-icms-vector
    depends_on:
      redpanda:
        condition: service_healthy
    volumes:
      - ./vector/vector.yaml:/etc/vector/vector.yaml:ro
    command: ["--config", "/etc/vector/vector.yaml"]

  debezium-connect:
    image: ${DEBEZIUM_CONNECT_IMAGE:-quay.io/debezium/connect:3.0.1.Final}
    container_name: jak-icms-debezium-connect
    depends_on:
      redpanda:
        condition: service_healthy
    ports:
      - "${DEBEZIUM_CONNECT_PORT:-8083}:8083"
    environment:
      BOOTSTRAP_SERVERS: redpanda:9092
      GROUP_ID: "1"
      CONFIG_STORAGE_TOPIC: debezium_connect_configs
      OFFSET_STORAGE_TOPIC: debezium_connect_offsets
      STATUS_STORAGE_TOPIC: debezium_connect_statuses
      KEY_CONVERTER: org.apache.kafka.connect.json.JsonConverter
      VALUE_CONVERTER: org.apache.kafka.connect.json.JsonConverter
      KEY_CONVERTER_SCHEMAS_ENABLE: "false"
      VALUE_CONVERTER_SCHEMAS_ENABLE: "false"
      CONNECT_REST_ADVERTISED_HOST_NAME: debezium-connect
      CONNECT_PLUGIN_PATH: /kafka/connect,/kafka/connect/debezium-connector-postgres
    volumes:
      - debezium_data:/kafka/data
    healthcheck:
      test: ["CMD-SHELL", "bash -c 'echo > /dev/tcp/localhost/8083' || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 20

  debezium-ui:
    image: ${DEBEZIUM_UI_IMAGE:-debezium/debezium-ui:latest}
    container_name: jak-icms-debezium-ui
    depends_on:
      debezium-connect:
        condition: service_healthy
    ports:
      - "${DEBEZIUM_UI_PORT:-8080}:8080"
    environment:
      KAFKA_CONNECT_URIS: http://debezium-connect:8083

  postgres:
    image: postgres:16
    container_name: jak-icms-postgres
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-debezium}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-debezium}
      POSTGRES_DB: ${POSTGRES_DB:-inventory}
    command:
      - postgres
      - -c
      - wal_level=logical
      - -c
      - max_wal_senders=10
      - -c
      - max_replication_slots=10
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./postgres/init:/docker-entrypoint-initdb.d:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-debezium} -d ${POSTGRES_DB:-inventory} || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10

volumes:
  redpanda_data:
  debezium_data:
  postgres_data:
